<p><a href="https://github.com/AshutoshIWNL/MonarchJavaAgent"><img src="https://img.shields.io/badge/GitHub-100000?style=for-the-badge&amp;logo=github&amp;logoColor=white" alt="GitHub" /></a></p>
<link rel="icon" type="image/x-icon" href="favicon.ico" />

<link rel="stylesheet" type="text/css" href="style.css" />

<h1 id="monarch-java-agent">Monarch Java Agent</h1>

<p>Monarch is a powerful Java agent for method monitoring and analysis. It offers various features to track method execution time, print stack traces, log method arguments and return values, capture heap dumps, and gather JVM-related information.</p>

<p>“Arise, shadows of execution!”</p>

<h2 id="key-abilities">Key Abilities</h2>

<ul>
  <li><strong>Shadow Trace Revelation:</strong> Unveil the stack trace upon a method’s invocation, illuminating the path of execution.</li>
  <li><strong>Shadow Argument Whispers:</strong> Capture and log the arguments passed to a method, discerning the secrets within.</li>
  <li><strong>Shadow Return Echoes:</strong> Record the return values of methods, listening to the echoes of their completion.</li>
  <li><strong>Shadow Code Infusion:</strong> Inject your own commands into the flow of execution, altering the very fabric of your application.</li>
  <li><strong>Shadow Time Capture:</strong> Command the agent to reveal the precise time taken for any method’s execution (Might get Eternal Slumber, beware).</li>
  <li><strong>Shadow Memory Grasp:</strong> Seize a heap dump at critical moments, capturing the memory landscape.</li>
  <li><strong>Shadow System Gaze:</strong> Peer into the system flags and JVM options, understanding the environment.</li>
  <li><strong>Shadow Resource Monitoring:</strong> Track heap and CPU usage, ensuring the shadows remain under control.</li>
  <li><strong>Shadow Garbage Collector Insight</strong>: Observe the movements of the JVM’s GC, tracking collection counts and times to anticipate system pauses.</li>
  <li><strong>Shadow Thread Watcher</strong>: Monitor all threads in the JVM, identifying peaks and anomalies like a shadow stalking its prey.</li>
  <li><strong>Shadow Classloader Vigil</strong>: Track loaded and unloaded classes, class load rates, and Metaspace usage, preventing rogue shadows from overwhelming the system.</li>
  <li><strong>Shadow Alert Sentinels:</strong> Deploy alert emails to notify you of critical resource usage, maintaining vigilance.</li>
</ul>

<h2 id="monargs">MonArgs</h2>

<table>
  <thead>
    <tr>
      <th>Argument</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">configFile</code></td>
      <td>Path to the configuration file specifying agent behavior <strong>[Mandatory]</strong>.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">agentLogFileDir</code></td>
      <td>Directory where initialization logs will be written.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">agentLogLevel</code></td>
      <td>Log verbosity level (<code class="language-plaintext highlighter-rouge">DEBUG</code>, <code class="language-plaintext highlighter-rouge">INFO</code>, <code class="language-plaintext highlighter-rouge">WARN</code>, <code class="language-plaintext highlighter-rouge">ERROR</code>).</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">smtpProperties</code></td>
      <td>Path to SMTP configuration for sending alert emails.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">agentJarPath</code></td>
      <td>Path to the MonarchJavaAgent jar <strong>[Mandatory for startup attach]</strong>.</td>
    </tr>
  </tbody>
</table>

<h2 id="summoning-the-monarch">Summoning the Monarch</h2>

<p>You can attach MonarchJavaAgent either during startup or during runtime.</p>

<p><strong>For startup:</strong></p>

<ol>
  <li>Download the latest agent JAR file from releases page.</li>
  <li>Start your Java application using the <code class="language-plaintext highlighter-rouge">-javaagent</code> option.</li>
  <li>Specify the configuration file and other options as needed.</li>
</ol>

<p>Example command to attach the agent:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>java <span class="nt">-Xverify</span>:none <span class="nt">-Xbootclasspath</span>/a:/path/to/MonarchJavaAgent-1.1-SNAPSHOT.jar <span class="nt">-javaagent</span>:/path/to/MonarchJavaAgent-1.1-SNAPSHOT.jar<span class="o">=</span><span class="nv">configFile</span><span class="o">=</span>/path/to/config.yaml,agentLogFileDir<span class="o">=</span>/path/to/log/dir,agentLogLevel<span class="o">=</span>DEBUG,smtpProperties<span class="o">=</span>/path/to/smtpProperties.props YourMainClass
</code></pre></div></div>

<p><strong>For Runtime:</strong></p>

<ol>
  <li>Download the latest agent JAR file from releases page.</li>
  <li>Start your application.</li>
  <li>Run “monarchAgentStart.bat”/”monarchAgentStart.sh” and provide the requested details.</li>
</ol>

<p>Example command run:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\U</span>sers<span class="se">\a</span>shut<span class="se">\m</span>onarch-java-agent<span class="se">\a</span>ttachScript&gt; .<span class="se">\m</span>onarchAgentStart.bat
Enter path to the agent JAR file: C:<span class="se">\U</span>sers<span class="se">\a</span>shut<span class="se">\m</span>onarch-java-agent<span class="se">\t</span>arget<span class="se">\M</span>onarchJavaAgent-1.1-SNAPSHOT.jar
Enter path to the agent config file: C:<span class="se">\U</span>sers<span class="se">\a</span>shut<span class="se">\m</span>onarch-java-agent<span class="se">\s</span>ampleConfig<span class="se">\m</span>Config.yaml
Enter arguments to pass to the agent: <span class="nv">agentLogFileDir</span><span class="o">=</span>C:<span class="se">\U</span>sers<span class="se">\a</span>shut<span class="se">\m</span>anualTesting,agentLogLevel<span class="o">=</span>DEBUG,smtpProperties<span class="o">=</span>/path/to/smtpProperties.props
Enter PID of the target JVM <span class="o">(</span>press Enter to use current JVM<span class="o">)</span>: 24300
Agent attached successfully to PID 24300
</code></pre></div></div>

<h2 id="commanding-the-shadows">Commanding the Shadows</h2>

<p>Below is a sample configuration YAML that you can use with MonarchJavaAgent:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">shouldInstrument</span><span class="pi">:</span> <span class="kc">true</span>
<span class="na">configRefreshInterval</span><span class="pi">:</span> <span class="m">15</span>
<span class="na">traceFileLocation</span><span class="pi">:</span> <span class="s">C:\\TraceFileDumps</span>
<span class="na">agentRules</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">ClassA::methodA@INGRESS::STACK</span>
  <span class="pi">-</span> <span class="s">ClassA::methodA@INGRESS::ARGS</span>
  <span class="pi">-</span> <span class="s">ClassA::methodA@EGRESS::RET</span>
  <span class="pi">-</span> <span class="s">ClassA::methodB@INGRESS::ARGS</span>
  <span class="pi">-</span> <span class="s">ClassA::methodB@INGRESS::STACK</span>
  <span class="pi">-</span> <span class="s">ClassA::methodB@EGRESS::STACK</span>
  <span class="pi">-</span> <span class="s">ClassA::methodB@EGRESS::RET</span>
  <span class="pi">-</span> <span class="s">ClassB::methodC@PROFILE</span>
  <span class="pi">-</span> <span class="s">ClassB::methodC@INGRESS::HEAP</span>
  <span class="pi">-</span> <span class="s">ClassB::methodC@INGRESS::ADD::[System.out.println(20);]</span>
  <span class="pi">-</span> <span class="s">ClassA::methodA@INGRESS::ADD::[System.out.println(this.getClass().getName());]</span>
  <span class="pi">-</span> <span class="s">ClassA::methodA@CODEPOINT(11)::ADD::[System.out.println(499);]</span>
  <span class="pi">-</span> <span class="s">ClassA::methodA@CODEPOINT(11)::ADD::[System.out.println(499 + "," + "Ashutosh Mishra");]</span>
<span class="na">printClassLoaderTrace</span><span class="pi">:</span> <span class="kc">true</span>
<span class="na">printJVMSystemProperties</span><span class="pi">:</span> <span class="kc">true</span>
<span class="na">printEnvironmentVariables</span><span class="pi">:</span> <span class="kc">true</span>
<span class="na">printJVMHeapUsage</span><span class="pi">:</span> <span class="kc">true</span>
<span class="na">printJVMCpuUsage</span><span class="pi">:</span> <span class="kc">true</span>
<span class="na">maxHeapDumps</span><span class="pi">:</span> <span class="m">3</span>
<span class="na">sendAlertEmails</span><span class="pi">:</span> <span class="kc">true</span>
<span class="na">emailRecipientList</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">abc@example.com</span>
  <span class="pi">-</span> <span class="s">ashutosh@asm.com</span>
</code></pre></div></div>

<h2 id="the-monarchs-decrees">The Monarch’s Decrees</h2>

<p>The rule syntax for MonarchJavaAgent follows the format:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;FQCN&gt;::&lt;MethodName&gt;@&lt;EVENT&gt;::&lt;ACTION&gt;
</code></pre></div></div>

<p>Where:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">&lt;FQCN&gt;</code>: Fully Qualified Class Name.</li>
  <li><code class="language-plaintext highlighter-rouge">&lt;MethodName&gt;</code>: Name of the method.</li>
  <li><code class="language-plaintext highlighter-rouge">&lt;EVENT&gt;</code>: Event at which the action should be performed. Possible values are:
    <ul>
      <li>INGRESS</li>
      <li>EGRESS</li>
      <li>CODEPOINT</li>
      <li>PROFILE (Note: PROFILE is a special case and no ACTION is required along with it.)</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">&lt;ACTION&gt;</code>: Action to be performed. Possible values are:
    <ul>
      <li>STACK: Print stack trace.</li>
      <li>HEAP: Capture heap dump.</li>
      <li>ARGS: Log method arguments.</li>
      <li>RET: Log method return value.</li>
      <li>ADD: Add custom code.</li>
    </ul>
  </li>
</ul>

<h2 id="forging-the-shadow">Forging the Shadow</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git https://github.com/AshutoshIWNL/MonarchJavaAgent.git
<span class="nb">cd </span>MonarchJavaAgent
mvn clean package
</code></pre></div></div>

<h2 id="the-architect-of-shadows">The Architect of Shadows</h2>

<ul>
  <li><strong>Ashutosh Mishra</strong> (https://github.com/AshutoshIWNL)</li>
</ul>

<h2 id="the-shadows-pact">The Shadow’s Pact</h2>

<p>This project is licensed under the Apache License 2.0 - see the <a href="LICENSE">LICENSE</a> file for details.</p>
